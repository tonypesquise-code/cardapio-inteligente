<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Mangiare</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    
    <style>
        :root {
            --brand-color: #DC0B1C; 
            --success: #00A944; 
            --brand-hover: #b50917;
            --bg-body: #f4f5f7; 
            --white: #ffffff;
            --text-main: #3e3e3e; 
            --text-muted: #717171; 
            --border-color: #e6e6e6;
            --warning: #eab308; 
            --primary-purple: #DC0B1C; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background-color: var(--white); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; height: 100%; z-index: 10; }
        .sidebar-header { padding: 24px 20px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: flex-start; text-align: left; }
        .sidebar-header img.main-logo { height: 20px; margin-bottom: 20px; }
        .store-identity-row { display: flex; align-items: center; justify-content: space-between; width: 100%; gap: 10px; }
        .store-status { display: flex; align-items: center; gap: 6px; background-color: #f0fdf4; border: 1px solid #bbf7d0; color: var(--success); padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: pointer; }
        .status-dot { width: 8px; height: 8px; background-color: var(--success); border-radius: 50%; }
        .circular-store-logo { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); background: white; }

        .nav-menu { flex: 1; padding: 16px 0; overflow-y: auto; display: flex; flex-direction: column; }
        .nav-item { padding: 12px 24px; display: flex; align-items: center; gap: 12px; color: var(--text-main); font-weight: 500; font-size: 0.95rem; cursor: pointer; border-left: 4px solid transparent; transition: 0.2s; }
        .nav-item:hover { background-color: #fcfcfc; }
        .nav-item.active { background-color: #fef2f2; color: var(--brand-color); border-left-color: var(--brand-color); font-weight: 600; }

        /* MAIN CONTENT */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .topbar { background-color: var(--white); height: 70px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; flex-shrink: 0; }
        .content-area { flex: 1; padding: 32px; overflow-y: auto; }
        .screen-section { display: none; animation: fadeIn 0.3s ease; }
        .screen-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* DASHBOARD */
        .dashboard-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
        .kpi-card { background: var(--white); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.02); display: flex; flex-direction: column; justify-content: center; }
        .kpi-icon { font-size: 1.5rem; margin-bottom: 8px; }
        .kpi-title { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 1.6rem; font-weight: 700; color: var(--text-main); margin-top: 4px; }
        
        .dashboard-grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px; }
        .panel-box { background: var(--white); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.02); padding: 24px; }
        .panel-title { font-size: 1.05rem; font-weight: 700; color: var(--text-main); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .ranking-list { list-style: none; }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .ranking-item:last-child { border-bottom: none; }
        .ranking-pos { font-weight: 700; color: var(--brand-color); width: 24px; }
        .ranking-name { flex: 1; font-weight: 500; font-size: 0.95rem; }
        .ranking-qtd { font-weight: 600; color: var(--text-muted); background: #f0f0f0; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; }

        .rating-big { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
        .rating-number { font-size: 3rem; font-weight: 700; color: var(--text-main); line-height: 1; }
        .rating-stars { color: #facc15; font-size: 1.2rem; }
        .review-bar-group { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-muted); }
        .review-bar-container { flex: 1; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; }
        .review-bar-fill { height: 100%; background: var(--success); border-radius: 4px; transition: width 0.5s ease; }

        /* KANBAN E CARDS */
        .kanban-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; min-height: 70vh; align-items: start; }
        .kanban-column { background: #e5e7eb; border-radius: 12px; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .kanban-header { font-weight: 700; font-size: 0.95rem; display: flex; justify-content: space-between; margin-bottom: 8px; color: #374151; }
        
        .order-card { background: var(--white); padding: 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid var(--text-muted); display: flex; flex-direction: column; gap: 10px; }
        .order-card.status-novo { border-left-color: var(--brand-color); }
        .order-card.status-preparo { border-left-color: var(--warning); }
        .order-card.status-pronto { border-left-color: var(--success); }

        .order-header-top { display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 1.1rem; }
        .sla-timer { font-size: 0.8rem; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; color: #374151; font-weight: 600; }
        .sla-timer.atrasado { background: #fee2e2; color: #dc2626; animation: piscarSLA 2s infinite; }
        @keyframes piscarSLA { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .action-row { display: flex; gap: 8px; margin-top: -4px; }
        .btn-mini { flex: 1; text-align: center; padding: 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; cursor: pointer; border: none; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .btn-wpp { background: #25D366; color: white; }
        .btn-print { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }

        .order-client { font-size: 0.95rem; font-weight: 600; color: var(--text-main); }
        .order-items { font-size: 0.85rem; color: var(--text-muted); line-height: 1.4; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; }
        .info-box { background: #f9fafb; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); }
        .info-box p { font-size: 0.8rem; margin-bottom: 4px; line-height: 1.3; }
        .order-total { font-size: 0.9rem; font-weight: 600; color: var(--success); text-align: right; }
        
        .btn-action { width: 100%; padding: 10px; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-action.btn-novo { background: var(--brand-color); }
        .btn-action.btn-preparo { background: var(--warning); color: #000; }
        .btn-action.btn-pronto { background: var(--success); }
        .btn-cancel { width: 100%; padding: 8px; background: transparent; color: var(--brand-color); border: 1px solid var(--brand-color); border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.85rem; }

        /* TABELA DE HIST√ìRICO */
        .historico-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .historico-table th, .historico-table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
        .historico-table th { background: #f9fafb; font-weight: 600; color: var(--text-muted); text-transform: uppercase; font-size: 0.8rem; }
        .status-badge { padding: 4px 8px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .bg-concluido { background: #dcfce7; color: #166534; }
        .bg-cancelado { background: #fee2e2; color: #991b1b; }

        /* IMPRESS√ÉO T√âRMICA */
        #cupom-impressao { display: none; }
        @media print {
            body * { visibility: hidden; margin: 0; padding: 0; }
            #cupom-impressao, #cupom-impressao * { visibility: visible; }
            #cupom-impressao { display: block; position: absolute; left: 0; top: 0; width: 300px; font-family: 'Courier New', Courier, monospace; font-size: 13px; color: #000; padding: 10px; }
            .print-hr { border-top: 1px dashed #000; margin: 8px 0; }
            .print-center { text-align: center; }
            .print-bold { font-weight: bold; }
        }

        /* --- ESTILOS DO M√ìDULO CARD√ÅPIO PRO --- */
        .cardapio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; align-items: start; margin-top: 20px;}
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 6px; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; background: #f9fafb; outline: none; transition: 0.2s; }
        .form-control:focus { border-color: var(--brand-color); background: var(--white); box-shadow: 0 0 0 3px rgba(220, 11, 28, 0.1); }
        
        .btn-ai { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; cursor: pointer; float: right; margin-bottom: 4px; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);}
        .btn-ai:hover { transform: scale(1.05); }

        .price-type-selector { display: flex; gap: 10px; margin-bottom: 16px; background: #f3f4f6; padding: 4px; border-radius: 8px; }
        .price-type-btn { flex: 1; padding: 8px; text-align: center; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); cursor: pointer; border-radius: 6px; transition: 0.2s; border: none; background: transparent; }
        .price-type-btn.active { background: var(--white); color: var(--text-main); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .variation-container { display: none; background: #f9fafb; border: 1px dashed #d1d5db; padding: 16px; border-radius: 8px; margin-bottom: 16px;}
        .variation-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; animation: fadeIn 0.3s ease; }
        .btn-remove-row { background: #fee2e2; color: #dc2626; border: none; width: 36px; height: 36px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-add-row { background: transparent; color: var(--brand-color); border: 1px dashed var(--brand-color); width: 100%; padding: 10px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-add-row:hover { background: #fef2f2; }

        .btn-save-product { width: 100%; padding: 14px; background: var(--success); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-save-product:hover { opacity: 0.9; }

        .cat-group { margin-bottom: 24px; }
        .cat-title { font-size: 1rem; font-weight: 700; color: var(--text-main); background: #f3f4f6; padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; }
        .product-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .product-list-item:last-child { border-bottom: none; }
        .prod-info { flex: 1; }
        .prod-name { font-weight: 600; font-size: 0.95rem; display: block; }
        .prod-price { font-size: 0.85rem; color: var(--success); font-weight: 600; }
        .prod-tags { font-size: 0.75rem; color: var(--text-muted); background: #f3f4f6; padding: 2px 6px; border-radius: 12px; margin-top: 4px; display: inline-block; }
        .btn-del-prod { background: none; border: none; color: var(--brand-color); cursor: pointer; font-size: 1.2rem; margin-left: 15px; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; transition: 0.2s; padding: 2px; }
        .btn-icon:hover { opacity: 0.7; transform: scale(1.1); }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(14px); }
        .item-paused { opacity: 0.5; filter: grayscale(100%); }
        .tag-highlight { font-size: 0.65rem; padding: 3px 6px; border-radius: 4px; font-weight: bold; margin-left: 6px; vertical-align: middle; }
        .tag-promo { background: #fee2e2; color: #dc2626; }
        .tag-top { background: #fef08a; color: #854d0e; }
        .tag-new { background: #e0e7ff; color: #4f46e5; }

        /* TABS INTERNAS DE CARD√ÅPIO (PRODUTO E PERSONALIZA√á√ÉO) */
        .cardapio-tabs-header { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 2px solid #e6e6e6; padding-bottom: 5px; }
        .card-tab-btn { background: transparent; border: none; padding: 10px 15px; font-size: 1rem; font-weight: 600; color: var(--text-muted); cursor: pointer; position: relative; transition: 0.2s; }
        .card-tab-btn.active { color: var(--brand-color); }
        .card-tab-btn.active::after { content: ''; position: absolute; bottom: -7px; left: 0; width: 100%; height: 3px; background: var(--brand-color); border-radius: 3px 3px 0 0; }
        .card-tab-content { display: none; animation: fadeIn 0.3s ease; }
        .card-tab-content.active { display: block; }

        /* ESTILOS DA PERSONALIZA√á√ÉO E MOCKUP SMARTPHONE */
        .color-picker-wrapper { display: flex; align-items: center; gap: 15px; }
        .color-picker { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 50px; height: 50px; background-color: transparent; border: none; cursor: pointer; padding: 0;}
        .color-picker::-webkit-color-swatch { border-radius: 8px; border: 2px solid #e6e6e6; }
        .banner-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .banner-item { display: flex; align-items: center; justify-content: space-between; background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #e6e6e6; }
        .banner-item img { height: 50px; width: 120px; border-radius: 4px; object-fit: cover; }
        .btn-delete-banner { background: #fee2e2; color: #dc2626; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 600; cursor: pointer; }

        /* Mockup do Celular na aba de personaliza√ß√£o */
        .smartphone-mockup {
            width: 320px;
            height: 640px;
            border: 2px solid #cbd5e1; /* Linha super fina */
            border-radius: 40px;
            background: #ffffff;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.05);
            margin: 0 auto;
        }
        .smartphone-mockup::before {
            content: '';
            position: absolute;
            top: 0; left: 50%;
            transform: translateX(-50%);
            width: 110px; height: 25px;
            background: #cbd5e1;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
            z-index: 20;
        }
        .mockup-scroll::-webkit-scrollbar { display: none; }
        .mockup-scroll { scrollbar-width: none; }

        /* MODAL DE IMPORTA√á√ÉO M√ÅGICA */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-import { background: var(--white); width: 90%; max-width: 700px; border-radius: 16px; overflow: hidden; animation: fadeIn 0.3s ease; display: flex; flex-direction: column; max-height: 90vh;}
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #fafafa;}
        .modal-header h3 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;}
        .modal-body { padding: 24px; overflow-y: auto; }
        
        .import-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;}
        .import-tab-btn { padding: 10px 20px; border: none; background: transparent; font-weight: 600; font-size: 0.95rem; color: var(--text-muted); cursor: pointer; position: relative; }
        .import-tab-btn.active { color: var(--brand-color); }
        .import-tab-btn.active::after { content: ''; position: absolute; bottom: -12px; left: 0; width: 100%; height: 2px; background: var(--brand-color); }
        
        .import-section { display: none; }
        .import-section.active { display: block; }
        
        .excel-area { width: 100%; height: 150px; font-family: monospace; font-size: 0.85rem; padding: 12px; border: 2px dashed #cbd5e1; border-radius: 8px; resize: none; background: #f8fafc; }
        .excel-area:focus { border-color: var(--brand-color); outline: none; background: white;}
        .instruction-box { background: #e0e7ff; border: 1px solid #c7d2fe; color: #3730a3; padding: 12px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 15px; }
        
        .ai-upload-box { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 40px 20px; text-align: center; background: #f8fafc; cursor: pointer; transition: 0.3s; position: relative;}
        .ai-upload-box:hover { border-color: var(--brand-color); background: #fef2f2; }
        .ai-upload-box input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        .scanner-fx { width: 100%; height: 4px; background: var(--brand-color); position: absolute; top: 0; left: 0; box-shadow: 0 0 10px var(--brand-color); animation: scan 2s linear infinite; display: none; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }

        /* FINANCEIRO STYLES */
        .fin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .fin-input-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; }
        .fin-input-group label { font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
        .fin-input-group input { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; }
        .cash-status { padding: 12px; border-radius: 8px; text-align: center; font-weight: 700; margin-bottom: 20px; font-size: 1.1rem; border: 1px solid transparent; }
        .cash-open { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .cash-closed { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .btn-fin { padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; }
        .btn-fin-success { background: var(--success); }
        .btn-fin-danger { background: var(--brand-color); }
        .fin-auth-overlay { position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.9); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); border-radius: 12px;}

        /* AVALIA√á√ïES */
        .av-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .av-header { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .av-name { font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .av-order { font-size: 0.8rem; color: var(--text-muted); background: #f3f4f6; padding: 2px 8px; border-radius: 12px; }
        .av-stars-row { display: flex; gap: 20px; margin-bottom: 12px; font-size: 0.9rem; }
        .av-comment { font-style: italic; color: #4b5563; font-size: 0.95rem; line-height: 1.5; background: #f8fafc; padding: 12px; border-radius: 8px; border-left: 3px solid var(--success); }

    </style>
</head>
<body>

    <div id="cupom-impressao"></div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="img/logo_mangiare.svg" alt="Mangiare" class="main-logo">
            
            <div class="store-identity-row">
                <div class="store-status"><div class="status-dot"></div> Loja Aberta</div>
                <img id="sidebar-loja-logo" src="https://via.placeholder.com/100?text=Logo" class="circular-store-logo" alt="Logo da Loja">
            </div>
        </div>

        <nav class="nav-menu">
            <div class="nav-item active" onclick="mudarTela('inicio', this)"><span class="nav-icon">üìä</span> Vis√£o Geral</div>
            <div class="nav-item" onclick="mudarTela('pedidos', this)"><span class="nav-icon">üìã</span> Pedidos (Cozinha)</div>
            <div class="nav-item" onclick="mudarTela('historico', this)"><span class="nav-icon">üìú</span> Hist√≥rico de Hoje</div>
            <div class="nav-item" onclick="mudarTela('avaliacoes', this)"><span class="nav-icon">‚≠ê</span> Avalia√ß√µes (NPS)</div>
            <div class="nav-item" onclick="mudarTela('cardapio', this)"><span class="nav-icon">üçî</span> Card√°pios</div>
            <div class="nav-item" onclick="mudarTela('financeiro', this)"><span class="nav-icon">üí∞</span> Financeiro</div>
            <div class="nav-item" onclick="mudarTela('configuracoes', this)"><span class="nav-icon">‚öôÔ∏è</span> Configura√ß√µes da Loja</div>
            
            <div class="nav-item" style="color: var(--brand-color); margin-top: auto;" onclick="window.fazerLogout()"><span class="nav-icon">üö™</span> Sair da Conta</div>
        </nav>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <h2 id="titulo-tela">Vis√£o Geral do Neg√≥cio</h2>
            <div style="display: flex; gap: 15px; align-items: center;">
                <button id="btn-copiar-link" style="background: #f3f4f6; color: var(--brand-color); border: 1px dashed var(--brand-color); padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s;" onclick="window.copiarLinkCardapio()">
                    üîó Copiar Meu Link
                </button>
                <button id="btn-silenciar" style="display: none; background: var(--brand-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; animation: piscar 1s infinite;" onclick="window.pararAlarme()">üîï Silenciar Alarme</button>
                <div>üîî <span id="contador-notificacoes" style="background: var(--brand-color); color: white; padding: 2px 6px; border-radius: 50%; font-size: 0.8rem; font-weight: bold; display: none;">0</span></div>
            </div>
        </header>

        <button id="btn-ativar-som" style="width: 100%; padding: 10px; background-color: #fef08a; color: #854d0e; border: none; font-weight: 600; cursor: pointer;">
            üîä Clique aqui para ativar o sistema de √°udio e impress√£o
        </button>

        <div class="content-area">
            
            <section id="tela-inicio" class="screen-section active">
                <div class="dashboard-grid-4">
                    <div class="kpi-card" style="border-bottom: 4px solid var(--success);">
                        <div class="kpi-icon">üí∞</div>
                        <div class="kpi-title">Faturamento Hoje</div>
                        <div class="kpi-value" id="kpi-faturamento">R$ 0,00</div>
                    </div>
                    <div class="kpi-card" style="border-bottom: 4px solid var(--success);">
                        <div class="kpi-icon">‚úÖ</div>
                        <div class="kpi-title">Pedidos Conclu√≠dos</div>
                        <div class="kpi-value" id="kpi-concluidos">0</div>
                    </div>
                    <div class="kpi-card" style="border-bottom: 4px solid #a855f7;">
                        <div class="kpi-icon">üìà</div>
                        <div class="kpi-title">Ticket M√©dio</div>
                        <div class="kpi-value" id="kpi-ticket">R$ 0,00</div>
                    </div>
                    <div class="kpi-card" style="border-bottom: 4px solid var(--brand-color);">
                        <div class="kpi-icon">‚ùå</div>
                        <div class="kpi-title">Cancelados</div>
                        <div class="kpi-value" id="kpi-cancelados">0</div>
                    </div>
                </div>

                <div class="dashboard-grid-2">
                    <div class="panel-box">
                        <div class="panel-title">Desempenho de Vendas (√öltimos 7 dias)</div>
                        <canvas id="graficoVendas" height="100"></canvas>
                    </div>

                    <div class="panel-box">
                        <div class="panel-title">üèÜ Campe√µes de Venda</div>
                        <ul class="ranking-list" id="lista-campeoes">
                            <p style="color: var(--text-muted); font-size: 0.9rem;">Aguardando vendas conclu√≠das...</p>
                        </ul>
                    </div>
                </div>

                <div class="dashboard-grid-2">
                    <div class="panel-box">
                        <div class="panel-title">Avalia√ß√µes da Loja <span style="font-weight: 400; font-size: 0.85rem; color: var(--text-muted); text-decoration: underline; cursor: pointer;" onclick="document.querySelectorAll('.nav-item')[3].click()">Ver coment√°rios</span></div>
                        <div class="rating-big">
                            <div class="rating-number" id="rating-number-big">0.0</div>
                            <div>
                                <div class="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;" id="rating-subtitle">Nenhuma avalia√ß√£o recebida ainda</div>
                            </div>
                        </div>
                        
                        <div class="review-bar-group"><span style="width: 10px;">5</span><span style="color: #facc15;">‚òÖ</span><div class="review-bar-container"><div class="review-bar-fill" id="bar-fill-5" style="width: 0%; transition: width 0.5s ease;"></div></div><span style="width: 30px; text-align: right;" id="bar-count-5">0</span></div>
                        <div class="review-bar-group"><span style="width: 10px;">4</span><span style="color: #facc15;">‚òÖ</span><div class="review-bar-container"><div class="review-bar-fill" id="bar-fill-4" style="width: 0%; background: #84cc16; transition: width 0.5s ease;"></div></div><span style="width: 30px; text-align: right;" id="bar-count-4">0</span></div>
                        <div class="review-bar-group"><span style="width: 10px;">3</span><span style="color: #facc15;">‚òÖ</span><div class="review-bar-container"><div class="review-bar-fill" id="bar-fill-3" style="width: 0%; background: #eab308; transition: width 0.5s ease;"></div></div><span style="width: 30px; text-align: right;" id="bar-count-3">0</span></div>
                        <div class="review-bar-group"><span style="width: 10px;">2</span><span style="color: #facc15;">‚òÖ</span><div class="review-bar-container"><div class="review-bar-fill" id="bar-fill-2" style="width: 0%; background: #f97316; transition: width 0.5s ease;"></div></div><span style="width: 30px; text-align: right;" id="bar-count-2">0</span></div>
                        <div class="review-bar-group"><span style="width: 10px;">1</span><span style="color: #facc15;">‚òÖ</span><div class="review-bar-container"><div class="review-bar-fill" id="bar-fill-1" style="width: 0%; background: var(--brand-color); transition: width 0.5s ease;"></div></div><span style="width: 30px; text-align: right;" id="bar-count-1">0</span></div>
                    </div>
                </div>
            </section>

            <section id="tela-pedidos" class="screen-section">
                <div class="kanban-board">
                    <div class="kanban-column">
                        <div class="kanban-header">Novos <span id="badge-novos" style="background: var(--brand-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">0</span></div>
                        <div id="coluna-novos"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-header">Em Preparo <span id="badge-preparo" style="background: var(--warning); padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">0</span></div>
                        <div id="coluna-preparo"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-header">Prontos / Despachados <span id="badge-prontos" style="background: var(--success); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">0</span></div>
                        <div id="coluna-prontos"></div>
                    </div>
                </div>
            </section>

            <section id="tela-historico" class="screen-section">
                <table class="historico-table">
                    <thead><tr><th>Pedido</th><th>Cliente</th><th>Status</th><th>Total</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="lista-historico"></tbody>
                </table>
            </section>

            <section id="tela-avaliacoes" class="screen-section">
                <div class="panel-box">
                    <div class="panel-title">
                        <span>‚≠ê Feed de Avalia√ß√µes de Clientes (NPS)</span>
                        <button class="btn-ai" style="background: linear-gradient(135deg, #3b82f6, #2563eb); font-size: 0.85rem;" onclick="window.simularAvaliacaoTeste()">üß™ Simular Avalia√ß√£o para Venda</button>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 20px;">Acompanhe o que os clientes est√£o achando da comida e do tempo de entrega em tempo real.</p>
                    
                    <div id="grid-avaliacoes" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <p style="color: var(--text-muted); font-size: 0.9rem;">Aguardando os clientes avaliarem os pedidos conclu√≠dos...</p>
                    </div>
                </div>
            </section>

            <section id="tela-cardapio" class="screen-section">
                
                <div class="cardapio-tabs-header">
                    <button class="card-tab-btn active" onclick="switchCardapioTab('produtos', this)">üçî Produtos e Categorias</button>
                    <button class="card-tab-btn" onclick="switchCardapioTab('personalizacao', this)">üé® Personaliza√ß√£o do Card√°pio</button>
                </div>

                <div id="tab-produtos" class="card-tab-content active">
                    <div class="cardapio-grid">
                        
                        <div class="panel-box">
                            <div class="panel-title" style="margin-bottom: 20px;">
                                <span>‚ûï Novo Produto</span>
                                <button type="button" class="btn-ai" style="background: linear-gradient(135deg, #10b981, #059669); font-size: 0.85rem;" onclick="document.getElementById('modal-importacao').style.display='flex'">üöÄ Importa√ß√£o M√°gica (Excel/IA)</button>
                            </div>
                            
                            <form id="form-produto">
                                <div class="form-group">
                                    <label class="form-label">Nome do Produto</label>
                                    <input type="text" id="prod-nome" class="form-control" placeholder="Ex: Pizza Margherita ou Combo Fam√≠lia" required>
                                </div>

                                <div style="display: flex; gap: 10px;">
                                    <div class="form-group" style="flex: 2;">
                                        <label class="form-label">Categoria</label>
                                        <input type="text" id="prod-categoria" list="categorias-existentes" class="form-control" placeholder="Ex: Pizzas, Bebidas..." required>
                                        <datalist id="categorias-existentes"></datalist>
                                    </div>
                                    <div class="form-group" style="flex: 1.5;">
                                        <label class="form-label">Etiqueta Especial</label>
                                        <select id="prod-tag" class="form-control">
                                            <option value="">Nenhuma</option>
                                            <option value="Promo√ß√£o">üåü Promo√ß√£o</option>
                                            <option value="Mais Vendido">üî• Mais Vendido</option>
                                            <option value="Novidade">‚ú® Novidade</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: inline-block;">Descri√ß√£o</label>
                                    <button type="button" class="btn-ai" onclick="melhorarComIA()" style="background: linear-gradient(135deg, #DC0B1C, #ff4757);">‚ú® Melhorar com IA</button>
                                    <textarea id="prod-descricao" class="form-control" rows="3" placeholder="Digite os ingredientes..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Tipo de Pre√ßo</label>
                                    <div class="price-type-selector">
                                        <button type="button" class="price-type-btn active" id="btn-preco-unico" onclick="togglePriceType('unico')">Pre√ßo √önico</button>
                                        <button type="button" class="price-type-btn" id="btn-preco-variacao" onclick="togglePriceType('variacao')">Tamanhos / Varia√ß√µes</button>
                                    </div>
                                </div>

                                <div class="form-group" id="container-preco-unico">
                                    <label class="form-label">Pre√ßo Fixo (R$)</label>
                                    <input type="number" step="0.01" id="prod-preco-unico" class="form-control" placeholder="Ex: 45.90">
                                </div>

                                <div class="variation-container" id="container-variacoes">
                                    <label class="form-label">Crie os tamanhos e pre√ßos:</label>
                                    <div id="lista-variacoes">
                                        <div class="variation-row">
                                            <input type="text" class="form-control var-nome" placeholder="Ex: Broto (4 Fatias)">
                                            <input type="number" step="0.01" class="form-control var-preco" placeholder="R$ 0,00">
                                        </div>
                                    </div>
                                    <button type="button" class="btn-add-row" onclick="addVariationRow()">+ Adicionar outro tamanho</button>
                                </div>

                                <div class="form-group" style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px dashed #d1d5db;">
                                    <label class="form-label" style="margin-bottom: 10px;">Adicionais / Opcionais Extras</label>
                                    <div id="lista-adicionais"></div>
                                    <button type="button" class="btn-add-row" onclick="addAdicionalRow()" style="border-color: var(--success); color: var(--success);">+ Inserir Opcional (Ex: Bacon + R$4,00)</button>
                                </div>

                                <div class="form-group">
    <label class="form-label">Imagem do Produto (Opcional)</label>
    <div style="display: flex; align-items: center; gap: 15px;">
        <img id="preview-prod-imagem" src="https://via.placeholder.com/80?text=Sem+Foto" style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 2px dashed #cbd5e1;">
        <div>
            <label style="background: #f3f4f6; color: var(--text-main); border: 1px solid #d1d5db; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                üì∑ Enviar Foto do Produto
                <input type="file" id="upload-prod-imagem" accept="image/*" style="display: none;">
            </label>
            <span id="status-upload-prod-imagem" style="display:none; color: var(--brand-color); font-size: 0.85rem; font-weight: 600; display: block; margin-top: 5px;">Enviando...</span>
        </div>
        <input type="hidden" id="prod-imagem" value="">
    </div>
</div>

                                <button type="submit" class="btn-save-product" id="btn-salvar-prod">Salvar no Card√°pio Online</button>
                            </form>
                        </div>

                        <div class="panel-box">
                            <div class="panel-title">üçî Card√°pio Ao Vivo</div>
                            <div id="vitrine-admin">
                                <p style="text-align: center; color: var(--text-muted); padding: 40px 0;">Carregando card√°pio...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-personalizacao" class="card-tab-content">
                    <div class="cardapio-grid" style="grid-template-columns: 1fr 1fr;">
                        
                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            <div class="panel-box">
                                <div class="panel-title">Identidade Visual</div>
                                
                                <div class="form-group">
                                    <label class="form-label">Cor Principal da Marca</label>
                                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">Essa cor vai pintar os bot√µes, os √≠cones de destaque e a barra do aplicativo do cliente.</p>
                                    <div class="color-picker-wrapper">
                                        <input type="color" id="pers-cor-marca" class="color-picker" value="#DC0B1C" oninput="atualizarCorMockup(this.value)">
                                        <button class="btn-save-product" style="margin-top: 0; width: auto; padding: 10px 20px; font-size: 0.9rem;" onclick="salvarCorMarca()">üíæ Salvar Cor</button>
                                    </div>
                                </div>

                                <hr style="border: 0; border-top: 1px solid #f0f0f0; margin: 25px 0;">

                                <div class="form-group">
                                    <label class="form-label">Capa do Perfil (Fundo do topo)</label>
                                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">Propor√ß√£o sugerida: Retangular (ex: 1200x400px).</p>
                                    
                                    <img id="preview-capa-loja" src="https://via.placeholder.com/600x200?text=Capa+da+Loja" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 2px dashed #cbd5e1; margin-bottom: 10px;">
                                    
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <label style="background: #f3f4f6; color: var(--text-main); border: 1px solid #d1d5db; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                            üì∑ Enviar Capa
                                            <input type="file" id="upload-capa-loja" accept="image/*" style="display: none;">
                                        </label>
                                        <button type="button" id="btn-delete-capa" style="display: none; background: none; border: none; color: var(--brand-color); font-size: 0.8rem; cursor: pointer; text-decoration: underline;">üóëÔ∏è Remover capa</button>
                                        <span id="status-upload-capa" style="display:none; color: var(--brand-color); font-size: 0.85rem; font-weight: 600;">Enviando...</span>
                                    </div>
                                </div>

                                <hr style="border: 0; border-top: 1px solid #f0f0f0; margin: 25px 0;">

                                <div class="form-group">
                                    <label class="form-label">Foto de Perfil (Logo)</label>
                                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">A mesma logo redonda usada nas configura√ß√µes.</p>
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <img id="preview-logo-pers" src="https://via.placeholder.com/150?text=Sua+Logo" style="width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 2px dashed #cbd5e1;">
                                        <div>
                                            <label style="background: #f3f4f6; color: var(--text-main); border: 1px solid #d1d5db; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                                üì∑ Alterar Logo
                                                <input type="file" id="upload-logo-pers" accept="image/*" style="display: none;">
                                            </label>
                                            <span id="status-upload-logo-pers" style="display:none; color: var(--brand-color); font-size: 0.85rem; font-weight: 600; display: block; margin-top: 5px;">Enviando...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="panel-box">
                                <div class="panel-title">Carrossel de Banners (Promo√ß√µes)</div>
                                <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">Adicione imagens para destacar ofertas. Se subir mais de uma, elas formam um carrossel.</p>
                                
                                <label class="ai-upload-box" style="padding: 25px 20px;">
                                    <div style="font-size: 1.8rem; margin-bottom: 5px;">üñºÔ∏è</div>
                                    <div style="font-weight: 600; color: var(--text-main);">Clique para enviar novo banner</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">Recomendado: Retangular (ex: 900x400px)</div>
                                    <input type="file" id="upload-banner" accept="image/*">
                                </label>
                                <span id="status-upload-banner" style="display:none; color: var(--brand-color); font-size: 0.85rem; margin-top: 8px; font-weight: 600; text-align: center; width: 100%;">Enviando banner... ‚è≥</span>

                                <div class="banner-list" id="lista-banners-ui">
                                    <p style="font-size: 0.85rem; color: var(--text-muted); text-align: center; padding: 20px 0;">Nenhum banner cadastrado.</p>
                                </div>
                            </div>
                        </div>

                        <div class="panel-box" style="display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background: #fafafa;">
                            <div class="panel-title" style="width: 100%; text-align: left;">Pr√©-visualiza√ß√£o (Mobile)</div>
                            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px; width: 100%; text-align: left;">Veja em tempo real como o aplicativo ficar√° na tela do seu cliente.</p>

                            <div class="smartphone-mockup">
                                <div class="mockup-scroll" style="height: 100%; overflow-y: auto; overflow-x: hidden; padding-bottom: 20px;">
                                    
                                    <div id="mockup-capa" style="width: 100%; height: 110px; background-color: var(--brand-color); background-size: cover; background-position: center;"></div>
                                    
                                    <div style="padding: 0 15px 15px; background: #fff; position: relative; border-bottom: 1px solid #f0f0f0;">
                                        <img id="mockup-logo" src="https://via.placeholder.com/150" style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #fff; position: absolute; top: -35px; left: 15px; object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: white;">
                                        <div style="padding-top: 40px;">
                                            <h3 id="mockup-nome" style="font-size: 1.1rem; margin-bottom: 2px;">Carregando...</h3>
                                            <div style="font-size: 0.7rem; color: #16a34a; font-weight: 700; display: flex; align-items: center; gap: 4px;"> <div style="width: 6px; height: 6px; background: #16a34a; border-radius: 50%;"></div> Aberto agora</div>
                                        </div>
                                    </div>

                                    <div id="mockup-banners-container" style="padding: 15px 0 15px 15px; background: #fff; display: none;">
                                        <div id="mockup-banners" class="mockup-scroll" style="display: flex; gap: 10px; overflow-x: auto; padding-right: 15px;">
                                            </div>
                                    </div>

                                    <div style="padding: 15px;">
                                        <div class="mockup-scroll" style="display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px;">
                                            <div id="mockup-cat-1" style="padding: 6px 12px; border-radius: 15px; border: 1px solid var(--brand-color); color: var(--brand-color); font-size: 0.7rem; font-weight: bold; background: #fef2f2; white-space: nowrap;">üçï Pizzas</div>
                                            <div style="padding: 6px 12px; border-radius: 15px; border: 1px solid #e5e7eb; color: #717171; font-size: 0.7rem; font-weight: bold; white-space: nowrap;">üçî Burguers</div>
                                            <div style="padding: 6px 12px; border-radius: 15px; border: 1px solid #e5e7eb; color: #717171; font-size: 0.7rem; font-weight: bold; white-space: nowrap;">ü•§ Bebidas</div>
                                        </div>

                                        <h4 style="font-size: 0.9rem; margin-bottom: 10px;">Destaques</h4>
                                        <div style="display: flex; gap: 10px; overflow: hidden; margin-bottom: 20px;">
                                            <div style="width: 90px; height: 90px; border-radius: 10px; background: #f3f4f6; flex-shrink: 0;"></div>
                                            <div style="width: 90px; height: 90px; border-radius: 10px; background: #f3f4f6; flex-shrink: 0;"></div>
                                            <div style="width: 90px; height: 90px; border-radius: 10px; background: #f3f4f6; flex-shrink: 0;"></div>
                                        </div>

                                        <h4 style="font-size: 0.9rem; margin-bottom: 10px;">Produtos</h4>
                                        <div style="display: flex; margin-bottom: 15px; gap: 10px;">
                                            <div style="flex: 1;">
                                                <div style="height: 12px; width: 80%; background: #e5e7eb; margin-bottom: 6px; border-radius: 4px;"></div>
                                                <div style="height: 10px; width: 100%; background: #f3f4f6; margin-bottom: 4px; border-radius: 4px;"></div>
                                                <div style="height: 10px; width: 60%; background: #f3f4f6; border-radius: 4px;"></div>
                                            </div>
                                            <div style="width: 60px; height: 60px; border-radius: 8px; background: #f3f4f6;"></div>
                                        </div>
                                        <div style="display: flex; gap: 10px;">
                                            <div style="flex: 1;">
                                                <div style="height: 12px; width: 80%; background: #e5e7eb; margin-bottom: 6px; border-radius: 4px;"></div>
                                                <div style="height: 10px; width: 100%; background: #f3f4f6; margin-bottom: 4px; border-radius: 4px;"></div>
                                                <div style="height: 10px; width: 60%; background: #f3f4f6; border-radius: 4px;"></div>
                                            </div>
                                            <div style="width: 60px; height: 60px; border-radius: 8px; background: #f3f4f6;"></div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            </div>

                    </div>
                </div>

            </section>

            <section id="tela-financeiro" class="screen-section" style="position: relative; min-height: 500px;">
                <div id="fin-auth-overlay" class="fin-auth-overlay">
                    <div class="panel-box" style="text-align: center; max-width: 400px; width: 100%;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">üîí</div>
                        <h3 style="margin-bottom: 10px; color: var(--text-main);">Acesso Restrito</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">Esta √°rea √© exclusiva para o Gestor/Admin. Digite a senha para configurar taxas e fluxo de caixa.</p>
                        <input type="password" id="senha-financeiro" class="form-control" placeholder="Senha de Acesso (digite: admin)" style="margin-bottom: 15px; text-align: center;">
                        <button class="btn-save-product" onclick="acessarFinanceiro()">Desbloquear M√≥dulo</button>
                    </div>
                </div>

                <div class="fin-grid">
                    <div class="panel-box">
                        <div class="panel-title">‚öôÔ∏è Configura√ß√£o de Taxas e Impostos</div>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">Configure os descontos para visualizar o lucro real no dashboard.</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="fin-input-group">
                                <label>Cart√£o de Cr√©dito (%)</label>
                                <input type="number" id="tax-credito" value="3.50" step="0.01">
                            </div>
                            <div class="fin-input-group">
                                <label>Cart√£o de D√©bito (%)</label>
                                <input type="number" id="tax-debito" value="1.90" step="0.01">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="fin-input-group">
                                <label>Taxa Pix (%)</label>
                                <input type="number" id="tax-pix" value="0.00" step="0.01">
                            </div>
                            <div class="fin-input-group">
                                <label>Pare Fiscal / Impostos (%)</label>
                                <input type="number" id="tax-imposto" value="4.00" step="0.01">
                            </div>
                        </div>

                        <button class="btn-save-product" onclick="salvarConfigFinanceiras()" style="background: var(--brand-color); margin-top: 10px;">üíæ Salvar Configura√ß√µes</button>
                    </div>

                    <div class="panel-box">
                        <div class="panel-title">üè¶ Gerenciamento de Caixa (Di√°rio)</div>
                        
                        <div id="cash-status-box" class="cash-status cash-closed">CAIXA FECHADO</div>
                        
                        <div class="fin-input-group">
                            <label>Fundo de Troco Inicial (R$)</label>
                            <input type="number" id="cash-start" value="150.00" step="0.01">
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                            <button class="btn-fin btn-fin-success" style="flex: 1;" onclick="abrirCaixa()">Abrir Caixa</button>
                            <button class="btn-fin btn-fin-danger" style="flex: 1;" onclick="fecharCaixa()">Fechar Caixa</button>
                        </div>

                        <div class="panel-title" style="font-size: 0.95rem; margin-bottom: 10px; border-top: 1px solid var(--border-color); padding-top: 15px;">Lan√ßamentos Manuais (Sangria/Aporte)</div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="desc-lancamento" class="form-control" placeholder="Descri√ß√£o (ex: Pgto Entregador)" style="flex: 2;">
                            <input type="number" id="valor-lancamento" class="form-control" placeholder="R$ 0,00" style="flex: 1;">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn-fin" style="background: var(--success); flex: 1;" onclick="adicionarLancamento('entrada')">‚ûï Aporte</button>
                            <button class="btn-fin" style="background: var(--brand-color); flex: 1;" onclick="adicionarLancamento('saida')">‚ûñ Sangria</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="tela-configuracoes" class="screen-section">
                <div class="dashboard-grid-2">
                    
                    <div class="panel-box">
                        <div class="panel-title">Informa√ß√µes do Estabelecimento</div>
                        <form id="form-config-loja">
                            
                            <div class="form-group" style="text-align: center; margin-bottom: 30px;">
                                <label class="form-label" style="margin-bottom: 10px;">Logo da sua Empresa</label>
                                
                                <button type="button" id="btn-delete-logo-config" style="display: none; background: none; border: none; color: var(--brand-color); font-size: 0.8rem; cursor: pointer; margin-bottom: 5px; text-decoration: underline;">üóëÔ∏è Remover logo atual</button>

                                <div>
                                    <img id="preview-logo-loja" src="https://via.placeholder.com/150?text=Sua+Logo" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px dashed #cbd5e1; margin-bottom: 15px;">
                                </div>

                                <div style="display: flex; justify-content: center;">
                                    <label style="background: #f3f4f6; color: var(--text-main); border: 1px solid #d1d5db; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                        üì∑ Trocar Foto
                                        <input type="file" id="upload-logo-loja" accept="image/*" style="display: none;">
                                    </label>
                                </div>

                                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">
                                    üí° <strong>Sugest√£o de tamanho:</strong> Use uma imagem quadrada (formato 1:1, ex: 500x500px) para n√£o cortar nas bordas circulares.
                                </p>

                                <span id="status-upload-logo" style="display:none; color: var(--brand-color); font-size: 0.85rem; margin-top: 8px; font-weight: 600;">Fazendo upload...</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Nome da Loja</label>
                                <input type="text" id="config-nome" class="form-control" required placeholder="Ex: Pizzaria Italiana">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Slogan (Aparece no topo do seu card√°pio online)</label>
                                <input type="text" id="config-slogan" class="form-control" placeholder="Ex: A verdadeira tradi√ß√£o em cada fatia">
                            </div>

                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                                <div class="form-group">
                                    <label class="form-label">WhatsApp (Para onde v√£o os pedidos)</label>
                                    <input type="tel" id="config-whatsapp" class="form-control" required placeholder="(00) 90000-0000">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">CNPJ (Opcional)</label>
                                    <input type="text" id="config-cnpj" class="form-control" placeholder="00.000.000/0001-00">
                                </div>
                            </div>

                            <div class="panel-title" style="margin-top: 30px; font-size: 0.95rem; border-top: 1px solid #f0f0f0; padding-top: 15px;">Endere√ßo F√≠sico</div>
                            
                            <div style="display:grid; grid-template-columns: 3fr 1fr; gap:15px;">
                                <div class="form-group">
                                    <label class="form-label">Rua / Avenida</label>
                                    <input type="text" id="config-rua" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">N√∫mero</label>
                                    <input type="text" id="config-numero" class="form-control">
                                </div>
                            </div>
                            
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                                <div class="form-group">
                                    <label class="form-label">Bairro</label>
                                    <input type="text" id="config-bairro" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cidade - UF</label>
                                    <input type="text" id="config-cidade" class="form-control" placeholder="Bituruna - PR">
                                </div>
                            </div>

                            <button type="submit" class="btn-save-product" id="btn-salvar-config">üíæ Salvar Altera√ß√µes</button>
                        </form>
                    </div>

                    <div class="panel-box">
                        <div class="panel-title">Como o sistema l√™ seu neg√≥cio</div>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">Estes s√£o os dados globais. Para editar cores e capas, acesse a aba Card√°pio > Personaliza√ß√£o.</p>
                        
                        <div style="border: 1px solid var(--border-color); border-radius: 16px; padding: 25px 20px; text-align: center; background: #fafafa; position: relative; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
                            <div style="height: 60px; background: #cbd5e1; position: absolute; top: 0; left: 0; right: 0;"></div>
                            
                            <img id="preview-cardapio-logo" src="https://via.placeholder.com/100" style="width: 90px; height: 90px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; z-index: 2; background: white;">
                            
                            <h3 id="preview-cardapio-nome" style="color: var(--text-main); margin-bottom: 5px; font-size: 1.2rem;">Sua Empresa</h3>
                            <p id="preview-cardapio-slogan" style="color: var(--text-muted); font-size: 0.85rem;">Seu slogan aparecer√° aqui</p>
                        </div>
                    </div>

                </div>
            </section>

        </div>
    </main>

    <div class="modal-overlay" id="modal-importacao">
        <div class="modal-import">
            <div class="modal-header">
                <h3>üöÄ Importa√ß√£o M√°gica</h3>
                <button style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#717171;" onclick="document.getElementById('modal-importacao').style.display='none'">&times;</button>
            </div>
            <div class="modal-body">
                <div class="import-tabs">
                    <button class="import-tab-btn active" onclick="trocarAbaImportacao('excel', this)">üìã Copiar do Excel</button>
                    <button class="import-tab-btn" onclick="trocarAbaImportacao('ia', this)">ü§ñ Escanear PDF/Imagem</button>
                </div>
                <div id="import-excel" class="import-section active">
                    <div class="instruction-box"><strong>Instru√ß√£o:</strong> Abra sua planilha, selecione as colunas: <b>Nome | Categoria | Pre√ßo | Descri√ß√£o</b>, copie e cole.</div>
                    <textarea id="texto-excel" class="excel-area" placeholder="Pizza Calabresa    Pizzas    45.90    Molho, mussarela e calabresa..."></textarea>
                    <button class="btn-save-product" onclick="window.processarPlanilhaExcel()" id="btn-processar-excel">Importar Planilha Agora</button>
                </div>
                <div id="import-ia" class="import-section">
                    <div class="instruction-box" style="background: #fdf4ff; border-color: #e879f9; color: #701a75;"><strong>IA:</strong> Envie foto do card√°pio ou PDF.</div>
                    <label class="ai-upload-box">
                        <div class="scanner-fx" id="scanner-fx"></div>
                        <div style="font-size: 2rem; margin-bottom: 10px;">üì∏</div>
                        <div style="font-weight: 600; color: var(--text-main);">Clique para enviar arquivo</div>
                        <input type="file" accept="image/*,.pdf" onchange="window.simularLeituraIA()">
                    </label>
                    <div id="ia-status" style="margin-top: 15px; display: none; text-align: center; font-weight: 600; color: var(--brand-color);"><p>üß† IA Analisando arquivo...</p></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-visualizar">
        <div class="modal-import" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="vis-nome">Detalhes do Produto</h3>
                <button style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#717171;" onclick="document.getElementById('modal-visualizar').style.display='none'">&times;</button>
            </div>
            <div class="modal-body" id="vis-body" style="line-height: 1.6; font-size: 0.95rem; color: var(--text-main);">
                </div>
        </div>
    </div>

    <script>
        function mudarTela(idDaTela, elementoClicado) {
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            elementoClicado.classList.add('active');
            document.querySelectorAll('.screen-section').forEach(tela => tela.classList.remove('active'));
            document.getElementById('tela-' + idDaTela).classList.add('active');

            const nomesDasTelas = { 'inicio': 'Vis√£o Geral do Neg√≥cio', 'pedidos': 'Gestor de Pedidos', 'historico': 'Hist√≥rico de Hoje', 'cardapio': 'Gest√£o Avan√ßada de Card√°pio', 'financeiro': 'Controle Financeiro e Caixa', 'avaliacoes':'Feed de Avalia√ß√µes de Clientes (NPS)', 'configuracoes': 'Configura√ß√µes da Empresa' };
            document.getElementById('titulo-tela').innerText = nomesDasTelas[idDaTela];
        }

        window.switchCardapioTab = function(tabId, elementoClicado) {
            document.querySelectorAll('.card-tab-btn').forEach(btn => btn.classList.remove('active'));
            elementoClicado.classList.add('active');
            document.querySelectorAll('.card-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        // M√°gica do Preview em tempo real da Cor do Mockup
        window.atualizarCorMockup = function(cor) {
            document.getElementById('mockup-capa').style.backgroundColor = cor;
            document.getElementById('mockup-cat-1').style.borderColor = cor;
            document.getElementById('mockup-cat-1').style.color = cor;
            
            // Cria uma vers√£o com transpar√™ncia pro fundo da p√≠lula ativa (opcional para ficar lindo)
            let opacityCor = cor + '1A'; // ~10% opacity in HEX
            document.getElementById('mockup-cat-1').style.backgroundColor = opacityCor;
        }

        function acessarFinanceiro() {
            const senha = document.getElementById('senha-financeiro').value;
            if(senha === 'admin' || senha === '1bu') { document.getElementById('fin-auth-overlay').style.display = 'none'; } else { alert('Senha incorreta!'); }
        }

        function salvarConfigFinanceiras() {
            const config = { credito: document.getElementById('tax-credito').value, debito: document.getElementById('tax-debito').value, pix: document.getElementById('tax-pix').value, imposto: document.getElementById('tax-imposto').value };
            localStorage.setItem('mangiare_fin_config', JSON.stringify(config));
            alert("‚úÖ Taxas atualizadas com sucesso!");
        }

        function abrirCaixa() {
            const statusBox = document.getElementById('cash-status-box');
            statusBox.innerText = "CAIXA ABERTO"; statusBox.className = "cash-status cash-open";
            localStorage.setItem('mangiare_cash_status', 'open'); alert("‚úÖ Caixa do dia aberto.");
        }

        function fecharCaixa() {
            if(confirm("Tem certeza que deseja fechar o caixa do dia?")) {
                const statusBox = document.getElementById('cash-status-box');
                statusBox.innerText = "CAIXA FECHADO"; statusBox.className = "cash-status cash-closed";
                localStorage.setItem('mangiare_cash_status', 'closed'); alert("üîí Caixa fechado.");
            }
        }

        function adicionarLancamento(tipo) {
            const desc = document.getElementById('desc-lancamento').value; const valor = document.getElementById('valor-lancamento').value;
            if(!desc || !valor) return alert("Preencha a descri√ß√£o e o valor!");
            alert(`‚úÖ Lan√ßamento registrado: ${tipo === 'entrada' ? 'Aporte' : 'Sangria'} de R$ ${valor} referente a "${desc}".`);
            document.getElementById('desc-lancamento').value = ''; document.getElementById('valor-lancamento').value = '';
        }

        window.addEventListener('DOMContentLoaded', () => {
            const config = JSON.parse(localStorage.getItem('mangiare_fin_config'));
            if(config) {
                if(document.getElementById('tax-credito')) document.getElementById('tax-credito').value = config.credito;
                if(document.getElementById('tax-debito')) document.getElementById('tax-debito').value = config.debito;
                if(document.getElementById('tax-pix')) document.getElementById('tax-pix').value = config.pix;
                if(document.getElementById('tax-imposto')) document.getElementById('tax-imposto').value = config.imposto || '4.00';
            }
            if(localStorage.getItem('mangiare_cash_status') === 'open') {
                const statusBox = document.getElementById('cash-status-box');
                if(statusBox) { statusBox.innerText = "CAIXA ABERTO"; statusBox.className = "cash-status cash-open"; }
            }
        });

        let tipoPrecoAtual = 'unico';
        window.togglePriceType = function(tipo) {
            tipoPrecoAtual = tipo;
            document.getElementById('btn-preco-unico').classList.remove('active'); document.getElementById('btn-preco-variacao').classList.remove('active');
            if(tipo === 'unico') {
                document.getElementById('btn-preco-unico').classList.add('active'); document.getElementById('container-preco-unico').style.display = 'block'; document.getElementById('container-variacoes').style.display = 'none'; document.getElementById('prod-preco-unico').required = true;
            } else {
                document.getElementById('btn-preco-variacao').classList.add('active'); document.getElementById('container-preco-unico').style.display = 'none'; document.getElementById('container-variacoes').style.display = 'block'; document.getElementById('prod-preco-unico').required = false;
            }
        }
        window.addVariationRow = function() {
    const container = document.getElementById('lista-variacoes'); 
    const div = document.createElement('div'); 
    div.className = 'variation-row';
    div.innerHTML = `<input type="text" class="form-control var-nome" placeholder="Ex: Grande"><input type="number" step="0.01" class="form-control var-preco" placeholder="R$ 0,00"><button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">üóëÔ∏è</button>`;
    container.appendChild(div);
}
        window.addAdicionalRow = function() {
            const container = document.getElementById('lista-adicionais'); const div = document.createElement('div'); div.className = 'variation-row adicional-row';
            div.innerHTML = `<input type="text" class="form-control add-nome" placeholder="Ex: Bacon Extra" required><input type="number" step="0.01" class="form-control add-preco" placeholder="Pre√ßo (Ex: 4.50)"><button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">üóëÔ∏è</button>`;
            container.appendChild(div);
        }

        window.melhorarComIA = function() {
            const txtArea = document.getElementById('prod-descricao'); const txt = txtArea.value.trim().toLowerCase(); const btn = document.querySelector('.btn-ai');
            if(!txt) return alert("Digite os ingredientes primeiro!");
            btn.innerText = "‚ú® Pensando..."; btn.disabled = true;
            setTimeout(() => {
                let r = txt.includes("burger")||txt.includes("hamburguer") ? "Blend artesanal suculento, grelhado √† perfei√ß√£o..." : `Experi√™ncia gastron√¥mica √∫nica! Ingredientes frescos e sabor inesquec√≠vel. (${txt})`;
                txtArea.value = r; btn.innerText = "‚ú® Melhorado!"; setTimeout(() => { btn.innerText = "‚ú® Melhorar com IA"; btn.disabled = false; }, 2000);
            }, 1200); 
        }

        function trocarAbaImportacao(abaId, elemento) {
            document.querySelectorAll('.import-tab-btn').forEach(btn => btn.classList.remove('active')); elemento.classList.add('active');
            document.querySelectorAll('.import-section').forEach(sec => sec.classList.remove('active')); document.getElementById('import-' + abaId).classList.add('active');
        }

        window.simularLeituraIA = function() {
            document.getElementById('scanner-fx').style.display = 'block'; const status = document.getElementById('ia-status'); status.style.display = 'block';
            setTimeout(() => { status.innerHTML = "<p>‚úÖ Escaneamento Conclu√≠do! 45 produtos identificados com sucesso.<br><span style='font-size:0.8rem; color:#717171;'>(Nota: No ambiente de demonstra√ß√£o, o cadastro autom√°tico est√° desativado. Use a aba Excel para cadastros reais).</span></p>"; document.getElementById('scanner-fx').style.display = 'none'; }, 3500);
        }

        const ctxChart = document.getElementById('graficoVendas').getContext('2d');
        new Chart(ctxChart, { type: 'line', data: { labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'], datasets: [{ label: 'Faturamento', data: [350, 420, 300, 680, 1250, 1500, 950], borderColor: '#DC0B1C', backgroundColor: 'rgba(220, 11, 28, 0.1)', borderWidth: 3, fill: true, tension: 0.4 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });

        let contextoAudio; let alarmeLoop = null;
        document.getElementById('btn-ativar-som').addEventListener('click', function() { contextoAudio = new (window.AudioContext || window.webkitAudioContext)(); tocarBipeUnico(); this.style.display = 'none'; });
        function tocarBipeUnico() { if (!contextoAudio) return; if (contextoAudio.state === 'suspended') contextoAudio.resume(); try { const tocarBipe = (f, i) => { const osc = contextoAudio.createOscillator(); const gain = contextoAudio.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(f, contextoAudio.currentTime + i); gain.gain.setValueAtTime(0.8, contextoAudio.currentTime + i); gain.gain.exponentialRampToValueAtTime(0.01, contextoAudio.currentTime + i + 0.3); osc.connect(gain); gain.connect(contextoAudio.destination); osc.start(contextoAudio.currentTime + i); osc.stop(contextoAudio.currentTime + i + 0.3); }; tocarBipe(880, 0); tocarBipe(1046.50, 0.2); } catch(e) {} }
        window.iniciarAlarmeContinuo = function() { if (alarmeLoop) return; tocarBipeUnico(); document.getElementById('btn-silenciar').style.display = 'inline-block'; alarmeLoop = setInterval(() => { tocarBipeUnico(); }, 3000); }
        window.pararAlarme = function() { if (alarmeLoop) { clearInterval(alarmeLoop); alarmeLoop = null; } document.getElementById('btn-silenciar').style.display = 'none'; }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, orderBy, doc, updateDoc, addDoc, deleteDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAB8wxPDhBhiX39dye_KvdapHUsDspbLsk",
            authDomain: "mangiare-79f67.firebaseapp.com",
            projectId: "mangiare-79f67",
            storageBucket: "mangiare-79f67.firebasestorage.app",
            messagingSenderId: "942988586703",
            appId: "1:942988586703:web:b0a1ac8f0a9532e74e91ba"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app); 
        
        let currentLojaId = null;
        window.currentLojaId = null; 
        
        const formatarMoeda = (valor) => valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentLojaId = user.uid;
                window.currentLojaId = user.uid;
                iniciarSistema(); 
            } else {
                window.location.href = 'login.html'; 
            }
        });

        window.fazerLogout = function() {
            signOut(auth).then(() => { window.location.href = 'login.html'; });
        }

        // --- L√ìGICA DE UPLOAD DE IMAGENS ---
        async function fazerUpload(file, pathPrefixo) {
            const storageRef = ref(storage, pathPrefixo + currentLojaId + '_' + Date.now());
            await uploadBytes(storageRef, file);
            return await getDownloadURL(storageRef);
        }

        const logicUploadLogo = async (e, statusId) => {
            const file = e.target.files[0]; if (!file) return;
            const statusLabel = document.getElementById(statusId);
            statusLabel.style.display = 'inline-block'; statusLabel.innerText = "Enviando logo... ‚è≥"; statusLabel.style.color = "var(--brand-color)";
            try {
                const downloadURL = await fazerUpload(file, 'logos_lojas/');
                await updateDoc(doc(db, "usuarios", currentLojaId), { logoUrl: downloadURL });
                statusLabel.innerText = "‚úÖ Salvo!"; statusLabel.style.color = "var(--success)"; setTimeout(() => statusLabel.style.display = 'none', 3000);
            } catch (error) { console.error("Erro no upload:", error); statusLabel.innerText = "‚ùå Erro."; }
        };
        
        document.getElementById('upload-logo-loja').addEventListener('change', (e) => logicUploadLogo(e, 'status-upload-logo'));
        document.getElementById('upload-logo-pers').addEventListener('change', (e) => logicUploadLogo(e, 'status-upload-logo-pers'));

        document.getElementById('btn-delete-logo-config')?.addEventListener('click', async () => {
            if(confirm("Tem certeza que deseja remover a logo?")) { await updateDoc(doc(db, "usuarios", currentLojaId), { logoUrl: null }); }
        });

        document.getElementById('upload-capa-loja').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const statusLabel = document.getElementById('status-upload-capa');
            statusLabel.style.display = 'inline-block'; statusLabel.innerText = "Enviando capa... ‚è≥";
            try {
                const downloadURL = await fazerUpload(file, 'capas_lojas/');
                await updateDoc(doc(db, "usuarios", currentLojaId), { capaUrl: downloadURL });
                statusLabel.innerText = "‚úÖ Capa salva!"; setTimeout(() => statusLabel.style.display = 'none', 3000);
            } catch (error) { statusLabel.innerText = "‚ùå Erro."; }
        });

        document.getElementById('btn-delete-capa').addEventListener('click', async () => {
            if(confirm("Tem certeza que deseja remover a capa?")) { await updateDoc(doc(db, "usuarios", currentLojaId), { capaUrl: null }); }
        });

        document.getElementById('upload-banner').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const statusLabel = document.getElementById('status-upload-banner');
            statusLabel.style.display = 'block'; statusLabel.innerText = "Enviando banner... ‚è≥";
            try {
                const downloadURL = await fazerUpload(file, 'banners_lojas/');
                const userDocRef = doc(db, "usuarios", currentLojaId);
                const docSnap = await getDoc(userDocRef);
                let bannersAtuais = (docSnap.exists() && docSnap.data().banners) ? docSnap.data().banners : [];
                bannersAtuais.push(downloadURL);
                await updateDoc(userDocRef, { banners: bannersAtuais });
                statusLabel.innerText = "‚úÖ Banner adicionado!"; setTimeout(() => statusLabel.style.display = 'none', 3000);
            } catch (error) { statusLabel.innerText = "‚ùå Erro."; }
        });

        window.removerBanner = async function(urlParaRemover) {
            if(confirm("Excluir este banner?")) {
                const userDocRef = doc(db, "usuarios", currentLojaId);
                const docSnap = await getDoc(userDocRef);
                if(docSnap.exists() && docSnap.data().banners) {
                    let bannersAtuais = docSnap.data().banners;
                    let novaLista = bannersAtuais.filter(url => url !== urlParaRemover);
                    await updateDoc(userDocRef, { banners: novaLista });
                }
            }
        };

        window.salvarCorMarca = async function() {
            const cor = document.getElementById('pers-cor-marca').value;
            await updateDoc(doc(db, "usuarios", currentLojaId), { corMarca: cor });
            alert("‚úÖ Cor da marca salva com sucesso! O aplicativo do cliente j√° foi atualizado com essa cor.");
        }

        document.getElementById('form-config-loja').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-salvar-config');
            btn.innerText = "Salvando... ‚è≥"; btn.disabled = true;
            try {
                await updateDoc(doc(db, "usuarios", currentLojaId), {
                    nomeEmpresa: document.getElementById('config-nome').value,
                    slogan: document.getElementById('config-slogan').value,
                    whatsapp: document.getElementById('config-whatsapp').value,
                    cnpj: document.getElementById('config-cnpj').value,
                    rua: document.getElementById('config-rua').value,
                    numero: document.getElementById('config-numero').value,
                    bairro: document.getElementById('config-bairro').value,
                    cidade: document.getElementById('config-cidade').value
                });
                alert("‚úÖ Configura√ß√µes da empresa salvas com sucesso!");
            } catch(error) { console.error(error); alert("Erro ao salvar."); } 
            finally { btn.innerText = "üíæ Salvar Altera√ß√µes"; btn.disabled = false; }
        });

        // =========================================================================
        // 1. L√ìGICA DE UPLOAD DA IMAGEM DO PRODUTO 
        // =========================================================================
        document.getElementById('upload-prod-imagem').addEventListener('change', async (e) => {
            const file = e.target.files[0]; 
            if (!file) return;
            
            const statusLabel = document.getElementById('status-upload-prod-imagem');
            statusLabel.style.display = 'block'; 
            statusLabel.innerText = "Enviando foto... ‚è≥";
            
            try {
                // Usa a fun√ß√£o fazerUpload que j√° existe no seu sistema
                const downloadURL = await fazerUpload(file, 'produtos_img/');
                document.getElementById('prod-imagem').value = downloadURL; // Salva URL no campo oculto
                document.getElementById('preview-prod-imagem').src = downloadURL; // Mostra a imagem
                statusLabel.innerText = "‚úÖ Foto pronta!"; 
                setTimeout(() => statusLabel.style.display = 'none', 3000);
            } catch (error) { 
                console.error("Erro no upload:", error); 
                statusLabel.innerText = "‚ùå Erro no envio."; 
            }
        });

       // =========================================================================
        // 2. L√ìGICA PARA SALVAR (OU ATUALIZAR) O PRODUTO NO FIREBASE
        // =========================================================================
        window.produtoEmEdicao = null; // Vari√°vel para rastrear se estamos criando ou editando

        document.getElementById('form-produto').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            
            const btnSalvar = document.getElementById('btn-salvar-prod');
            const textoOriginalBtn = btnSalvar.innerText;
            btnSalvar.innerText = "Salvando... ‚è≥"; 
            btnSalvar.disabled = true;

            try {
                const isPrecoUnico = document.getElementById('btn-preco-unico').classList.contains('active');
                const tipoPrecoFinal = isPrecoUnico ? 'unico' : 'variacao';

                let pratoData = {
                    lojaId: currentLojaId, 
                    nome: document.getElementById('prod-nome').value,
                    categoria: document.getElementById('prod-categoria').value,
                    destaque: document.getElementById('prod-tag').value,
                    descricao: document.getElementById('prod-descricao').value,
                    imagem: document.getElementById('prod-imagem').value, 
                    ativo: true,
                    tipoPreco: tipoPrecoFinal
                };

                if (isPrecoUnico) {
                    pratoData.preco = parseFloat(document.getElementById('prod-preco-unico').value) || 0;
                } else {
                    let variacoes = [];
                    let precoBase = 0;
                    document.querySelectorAll('#lista-variacoes .variation-row').forEach((row, index) => {
                        const vNome = row.querySelector('.var-nome').value;
                        const vPreco = parseFloat(row.querySelector('.var-preco').value) || 0;
                        if(vNome) {
                            variacoes.push({ nome: vNome, preco: vPreco });
                            if (index === 0 || vPreco < precoBase) precoBase = vPreco;
                        }
                    });
                    pratoData.variacoes = variacoes;
                    pratoData.precoBase = precoBase;
                }

                let adicionais = [];
                document.querySelectorAll('#lista-adicionais .adicional-row').forEach(row => {
                    const aNome = row.querySelector('.add-nome').value;
                    const aPreco = row.querySelector('.add-preco').value;
                    if(aNome) {
                        adicionais.push({ nome: aNome, preco: aPreco ? parseFloat(aPreco) : 0 });
                    }
                });
                pratoData.adicionais = adicionais;

                if (window.produtoEmEdicao) {
                    // MODO ATUALIZAR
                    await updateDoc(doc(db, "pratos_cantina", window.produtoEmEdicao), pratoData);
                    alert("‚úÖ Produto atualizado com sucesso!");
                    window.cancelarEdicaoProduto(); // Volta pro modo "Novo Produto"
                } else {
                    // MODO NOVO PRODUTO
                    pratoData.dataCriacao = serverTimestamp();
                    await addDoc(collection(db, "pratos_cantina"), pratoData);
                    alert("‚úÖ Produto adicionado com sucesso!");
                    window.cancelarEdicaoProduto();
                }

            } catch (error) {
                console.error("Erro ao salvar produto: ", error);
                alert("Erro ao tentar salvar o produto. Verifique a conex√£o com o banco de dados.");
            } finally {
                btnSalvar.innerText = window.produtoEmEdicao ? "Atualizar Produto" : "Salvar no Card√°pio Online";
                btnSalvar.disabled = false;
            }
        });

        // --- FUN√á√ïES DE EDI√á√ÉO E VISUALIZA√á√ÉO ---

        window.abrirEdicaoProduto = function(id) {
            const p = window.cacheProdutosGlobais[id];
            if (!p) return;
            window.produtoEmEdicao = id;
            
            // Preenche os dados b√°sicos
            document.getElementById('prod-nome').value = p.nome || '';
            document.getElementById('prod-categoria').value = p.categoria || '';
            document.getElementById('prod-tag').value = p.destaque || '';
            document.getElementById('prod-descricao').value = p.descricao || '';
            
            // Preenche a imagem
            const previewImg = document.getElementById('preview-prod-imagem');
            const hiddenImg = document.getElementById('prod-imagem');
            if(p.imagem) {
                if(previewImg) previewImg.src = p.imagem;
                if(hiddenImg) hiddenImg.value = p.imagem;
            } else {
                if(previewImg) previewImg.src = 'https://via.placeholder.com/80?text=Sem+Foto';
                if(hiddenImg) hiddenImg.value = '';
            }

            // Preenche os pre√ßos
            window.togglePriceType(p.tipoPreco);
            if(p.tipoPreco === 'unico') {
                document.getElementById('prod-preco-unico').value = p.preco || '';
            } else {
                const contVar = document.getElementById('lista-variacoes');
                contVar.innerHTML = '';
                if(p.variacoes) {
                    p.variacoes.forEach(v => {
                        const div = document.createElement('div'); div.className = 'variation-row';
                        div.innerHTML = `<input type="text" class="form-control var-nome" value="${v.nome}"><input type="number" step="0.01" class="form-control var-preco" value="${v.preco}"><button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">üóëÔ∏è</button>`;
                        contVar.appendChild(div);
                    });
                }
            }

            // Preenche adicionais
            const contAdd = document.getElementById('lista-adicionais');
            contAdd.innerHTML = '';
            if(p.adicionais && p.adicionais.length > 0) {
                p.adicionais.forEach(a => {
                    const div = document.createElement('div'); div.className = 'variation-row adicional-row';
                    div.innerHTML = `<input type="text" class="form-control add-nome" value="${a.nome}"><input type="number" step="0.01" class="form-control add-preco" value="${a.preco}"><button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">üóëÔ∏è</button>`;
                    contAdd.appendChild(div);
                });
            }

            // Altera o visual do bot√£o
            const btn = document.getElementById('btn-salvar-prod');
            btn.innerText = "Atualizar Produto";
            btn.style.background = "#3b82f6"; // Azul de edi√ß√£o
            
            // Exibe o bot√£o de cancelar edi√ß√£o
            let btnCancelar = document.getElementById('btn-cancelar-edicao');
            if(!btnCancelar) {
                btnCancelar = document.createElement('button');
                btnCancelar.id = 'btn-cancelar-edicao';
                btnCancelar.type = 'button';
                btnCancelar.className = 'btn-cancel';
                btnCancelar.style.marginTop = '10px';
                btnCancelar.innerText = 'Cancelar Edi√ß√£o (Voltar para Novo)';
                btnCancelar.onclick = window.cancelarEdicaoProduto;
                btn.parentNode.insertBefore(btnCancelar, btn.nextSibling);
            }
            btnCancelar.style.display = 'block';

            // Joga a tela pra cima
            document.querySelector('.content-area').scrollTo({top: 0, behavior: 'smooth'});
        }

        window.cancelarEdicaoProduto = function() {
            window.produtoEmEdicao = null;
            document.getElementById('form-produto').reset();
            
            // Restaura o bot√£o original
            const btn = document.getElementById('btn-salvar-prod');
            btn.innerText = "Salvar no Card√°pio Online";
            btn.style.background = "var(--success)";
            
            // Esconde o bot√£o de cancelar
            const btnCancelar = document.getElementById('btn-cancelar-edicao');
            if(btnCancelar) btnCancelar.style.display = 'none';

            // Reseta imagem
            const previewImg = document.getElementById('preview-prod-imagem');
            if(previewImg) previewImg.src = 'https://via.placeholder.com/80?text=Sem+Foto';
            const hiddenImg = document.getElementById('prod-imagem');
            if(hiddenImg) hiddenImg.value = '';

            // Reseta arrays
            document.getElementById('lista-variacoes').innerHTML = '<div class="variation-row"><input type="text" class="form-control var-nome" placeholder="Ex: Broto (4 Fatias)"><input type="number" step="0.01" class="form-control var-preco" placeholder="R$ 0,00"></div>';
            document.getElementById('lista-adicionais').innerHTML = '';
            window.togglePriceType('unico');
        }

        window.visualizarProduto = function(id) {
            const p = window.cacheProdutosGlobais[id];
            if (!p) return;
            
            let html = '';
            if(p.imagem) html += `<img src="${p.imagem}" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:15px;">`;
            html += `<p style="margin-bottom:8px;"><strong>Categoria:</strong> ${p.categoria}</p>`;
            if(p.descricao) html += `<p style="margin-bottom:8px; padding: 10px; background: #f9fafb; border-radius: 6px;">${p.descricao}</p>`;
            
            if(p.tipoPreco === 'unico') {
                html += `<p style="margin-bottom:8px;"><strong>Pre√ßo Fixo:</strong> <span style="color:var(--success); font-weight:bold;">${formatarMoeda(p.preco)}</span></p>`;
            } else {
                html += `<p style="margin-bottom:8px;"><strong>Varia√ß√µes de Tamanho:</strong></p><ul style="margin-left:20px; margin-bottom:10px;">`;
                p.variacoes.forEach(v => { html += `<li>${v.nome} - <span style="color:var(--success); font-weight:bold;">${formatarMoeda(v.preco)}</span></li>`; });
                html += `</ul>`;
            }
            
            if(p.adicionais && p.adicionais.length > 0) {
                html += `<p style="margin-bottom:8px;"><strong>Adicionais Dispon√≠veis:</strong></p><ul style="margin-left:20px;">`;
                p.adicionais.forEach(a => { html += `<li>${a.nome} <span style="color:var(--text-muted);">(+ ${formatarMoeda(a.preco)})</span></li>`; });
                html += `</ul>`;
            }

            document.getElementById('vis-nome').innerText = p.nome;
            document.getElementById('vis-body').innerHTML = html;
            document.getElementById('modal-visualizar').style.display = 'flex';
        }

        function iniciarSistema() {
            onSnapshot(doc(db, "usuarios", currentLojaId), (docSnap) => {
                if(docSnap.exists()) {
                    const dados = docSnap.data();
                    
                    document.getElementById('config-nome').value = dados.nomeEmpresa || '';
                    document.getElementById('config-slogan').value = dados.slogan || '';
                    document.getElementById('config-whatsapp').value = dados.whatsapp || '';
                    document.getElementById('config-cnpj').value = dados.cnpj || '';
                    document.getElementById('config-rua').value = dados.rua || '';
                    document.getElementById('config-numero').value = dados.numero || '';
                    document.getElementById('config-bairro').value = dados.bairro || '';
                    document.getElementById('config-cidade').value = dados.cidade || '';

                    // Atualiza Nome no Mockup e Preview antigo
                    document.getElementById('preview-cardapio-nome').innerText = dados.nomeEmpresa || 'Sua Empresa';
                    document.getElementById('preview-cardapio-slogan').innerText = dados.slogan || 'Seu slogan aparecer√° aqui';
                    document.getElementById('mockup-nome').innerText = dados.nomeEmpresa || 'Sua Empresa';

                    // Logo em todos os lugares
                    const imgLogo = dados.logoUrl || 'https://via.placeholder.com/150?text=Sem+Logo';
                    document.getElementById('sidebar-loja-logo').src = imgLogo;
                    document.getElementById('preview-logo-loja').src = imgLogo;
                    document.getElementById('preview-logo-pers').src = imgLogo;
                    document.getElementById('preview-cardapio-logo').src = imgLogo;
                    document.getElementById('mockup-logo').src = imgLogo;
                    
                    if(dados.logoUrl) {
                        const btnDel = document.getElementById('btn-delete-logo-config');
                        if (btnDel) btnDel.style.display = 'inline-block';
                    }

                    // Cor e Capa no Mockup e Preview antigo
                    if (dados.corMarca) {
                        document.getElementById('pers-cor-marca').value = dados.corMarca;
                        window.atualizarCorMockup(dados.corMarca); // M√°gica em tempo real para quem j√° salvou antes
                    }
                    
                    if (dados.capaUrl) {
                        document.getElementById('preview-capa-loja').src = dados.capaUrl;
                        document.getElementById('btn-delete-capa').style.display = 'inline-block';
                        document.getElementById('mockup-capa').style.backgroundImage = `url(${dados.capaUrl})`;
                        document.getElementById('mockup-capa').style.backgroundSize = 'cover';
                        document.getElementById('mockup-capa').style.backgroundPosition = 'center';
                    } else {
                        document.getElementById('preview-capa-loja').src = 'https://via.placeholder.com/600x200?text=Capa+da+Loja';
                        document.getElementById('btn-delete-capa').style.display = 'none';
                        document.getElementById('mockup-capa').style.backgroundImage = 'none';
                    }

                    // Banners
                    const listaBannersUi = document.getElementById('lista-banners-ui');
                    const mockupBannersContainer = document.getElementById('mockup-banners-container');
                    const mockupBanners = document.getElementById('mockup-banners');

                    if(dados.banners && dados.banners.length > 0) {
                        listaBannersUi.innerHTML = '';
                        mockupBanners.innerHTML = '';
                        mockupBannersContainer.style.display = 'block';

                        dados.banners.forEach((url, index) => {
                            // Lista do admin
                            listaBannersUi.innerHTML += `
                                <div class="banner-item">
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <span style="font-weight: bold; color: var(--text-muted);">${index + 1}</span>
                                        <img src="${url}">
                                    </div>
                                    <button class="btn-delete-banner" onclick="window.removerBanner('${url}')">üóëÔ∏è Excluir</button>
                                </div>
                            `;
                            // Mockup celular
                            mockupBanners.innerHTML += `<img src="${url}" style="flex: 0 0 88%; height: 90px; border-radius: 8px; object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.05); background: #f0f0f0;">`;
                        });
                    } else {
                        listaBannersUi.innerHTML = '<p style="font-size: 0.85rem; color: var(--text-muted); text-align: center; padding: 20px 0;">Nenhum banner cadastrado.</p>';
                        mockupBannersContainer.style.display = 'none';
                    }
                }
            });

            onSnapshot(query(collection(db, "pratos_cantina"), where("lojaId", "==", currentLojaId), orderBy("dataCriacao", "desc")), (snapshot) => {
                const vitrine = document.getElementById('vitrine-admin'); const datalistCategorias = document.getElementById('categorias-existentes');
                vitrine.innerHTML = ''; let categoriasUnicas = new Set(); let produtosAgrupados = {};
                
                window.cacheProdutosGlobais = {}; // Guarda os produtos na mem√≥ria

                if (snapshot.empty) { vitrine.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Card√°pio vazio.</p>'; return; }
                
                snapshot.forEach(docSnap => { 
                    const p = docSnap.data(); p.id = docSnap.id; 
                    window.cacheProdutosGlobais[p.id] = p; // Salva no cache global
                    categoriasUnicas.add(p.categoria); 
                    if(!produtosAgrupados[p.categoria]) produtosAgrupados[p.categoria] = []; 
                    produtosAgrupados[p.categoria].push(p); 
                });

                datalistCategorias.innerHTML = '';
                categoriasUnicas.forEach(cat => {
                    datalistCategorias.innerHTML += `<option value="${cat}">`; let listaProdutosHTML = '';
                    produtosAgrupados[cat].forEach(prod => {
                        let displayPreco = (prod.tipoPreco === 'variacao' && prod.variacoes) ? `<span class="prod-tags">Tamanhos Variados (A partir de ${formatarMoeda(prod.precoBase)})</span>` : `<span class="prod-price">${formatarMoeda(prod.preco || 0)}</span>`;
                        let tagHTML = '';
                        if(prod.destaque === 'Promo√ß√£o') tagHTML = '<span class="tag-highlight tag-promo">üåü Promo√ß√£o</span>';
                        else if(prod.destaque === 'Mais Vendido') tagHTML = '<span class="tag-highlight tag-top">üî• Mais Vendido</span>';
                        else if(prod.destaque === 'Novidade') tagHTML = '<span class="tag-highlight tag-new">‚ú® Novidade</span>';
                        let addHTML = '';
                        if(prod.adicionais && prod.adicionais.length > 0) addHTML = `<div style="font-size:0.75rem; color:var(--text-muted); margin-top:4px;">‚ûï Possui ${prod.adicionais.length} opcionais</div>`;
                        const isAtivo = prod.ativo !== false; const checkedAttr = isAtivo ? 'checked' : ''; const pausedClass = isAtivo ? '' : 'item-paused';
                        
                        // NOVOS BOT√ïES INSERIDOS AQUI:
                        let botoesAcao = `<div style="display:flex; align-items:center; gap: 10px;">
                            <button class="btn-icon" onclick="window.visualizarProduto('${prod.id}')" title="Visualizar Detalhes">üëÅÔ∏è</button>
                            <button class="btn-icon" onclick="window.abrirEdicaoProduto('${prod.id}')" title="Editar Produto">‚úèÔ∏è</button>
                            <label class="switch" title="Ativar/Pausar Produto no app do cliente"><input type="checkbox" ${checkedAttr} onchange="window.toggleProdutoStatus('${prod.id}', this.checked)"><span class="slider"></span></label>
                            <button class="btn-icon" style="color: var(--brand-color);" onclick="window.deletarProduto('${prod.id}')" title="Excluir Definitivamente">üóëÔ∏è</button>
                        </div>`;

                        listaProdutosHTML += `<div class="product-list-item ${pausedClass}"><div class="prod-info"><span class="prod-name">${prod.nome} ${tagHTML}</span>${displayPreco}${addHTML}</div>${botoesAcao}</div>`;
                    });
                    vitrine.innerHTML += `<div class="cat-group"><div class="cat-title">${cat}</div>${listaProdutosHTML}</div>`;
                });
            });

            const pedidosRef = collection(db, "pedidos"); 
            const qPedidos = query(pedidosRef, where("lojaId", "==", currentLojaId), orderBy("dataCriacao", "asc"));
            let primeiraCargaDoSistema = true; window.cachePedidosGlobais = {}; 
            onSnapshot(qPedidos, (snapshot) => {
                const colunaNovos = document.getElementById('coluna-novos'); const colunaPreparo = document.getElementById('coluna-preparo'); const colunaProntos = document.getElementById('coluna-prontos'); const listaHistorico = document.getElementById('lista-historico');
                const gridAvaliacoes = document.getElementById('grid-avaliacoes');
                if(colunaNovos) colunaNovos.innerHTML = ''; if(colunaPreparo) colunaPreparo.innerHTML = ''; if(colunaProntos) colunaProntos.innerHTML = ''; if(listaHistorico) listaHistorico.innerHTML = ''; if(gridAvaliacoes) gridAvaliacoes.innerHTML = '';
                let contNovos = 0, contPreparo = 0, contProntos = 0; let faturamentoConcluidos = 0; let qtdConcluidos = 0; let contCancelados = 0; let dicionarioProdutos = {};
                let totalAvals = 0, somaNotas = 0, distAvals = {5:0, 4:0, 3:0, 2:0, 1:0};
                let temPedidoNovo = false; snapshot.docChanges().forEach((change) => { if (change.type === "added" && !primeiraCargaDoSistema) temPedidoNovo = true; });
                if (temPedidoNovo && window.iniciarAlarmeContinuo) window.iniciarAlarmeContinuo(); primeiraCargaDoSistema = false;
                snapshot.forEach((documento) => {
                    const pedido = documento.data(); const idPedido = documento.id; window.cachePedidosGlobais[idPedido] = pedido;
                    const precoFormatado = pedido.total ? formatarMoeda(pedido.total) : 'R$ 0,00'; const numPedido = idPedido.substring(idPedido.length - 4).toUpperCase();
                    if (pedido.avaliacao) {
                        totalAvals++; const mediaPedido = Math.round((pedido.avaliacao.comida + pedido.avaliacao.entrega) / 2); somaNotas += mediaPedido; if(distAvals[mediaPedido] !== undefined) distAvals[mediaPedido]++;
                        if(gridAvaliacoes) { gridAvaliacoes.innerHTML += `<div class="av-card"><div class="av-header"><span class="av-name">üë§ ${pedido.clienteNome || 'An√¥nimo'}</span><span class="av-order">Pedido #${numPedido}</span></div><div class="av-stars-row"><div>üçî Comida: <span style="color:#facc15;">${'‚òÖ'.repeat(pedido.avaliacao.comida)}${'‚òÜ'.repeat(5 - pedido.avaliacao.comida)}</span></div><div>üõµ Entrega: <span style="color:#facc15;">${'‚òÖ'.repeat(pedido.avaliacao.entrega)}${'‚òÜ'.repeat(5 - pedido.avaliacao.entrega)}</span></div></div><div class="av-comment">"${pedido.avaliacao.comentario || 'Sem coment√°rio escrito'}"</div></div>`; }
                    }
                    if (pedido.status === 'cancelado') { contCancelados++; if(listaHistorico) listaHistorico.innerHTML += `<tr><td style="font-weight:bold;">#${numPedido}</td><td>${pedido.clienteNome}</td><td><span class="status-badge bg-cancelado">Cancelado</span></td><td style="font-weight:600;">${precoFormatado}</td><td><button class="btn-print" onclick="window.imprimirCupom('${idPedido}')">üñ®Ô∏è Recibo</button></td></tr>`; return; }
                    if (pedido.status === 'concluido') { faturamentoConcluidos += pedido.total; qtdConcluidos++; if(pedido.itens) pedido.itens.forEach(item => { dicionarioProdutos[item.nome] = (dicionarioProdutos[item.nome] || 0) + item.quantidade; }); if(listaHistorico) listaHistorico.innerHTML += `<tr><td style="font-weight:bold;">#${numPedido}</td><td>${pedido.clienteNome}</td><td><span class="status-badge bg-concluido">Entregue</span></td><td style="font-weight:600;">${precoFormatado}</td><td><button class="btn-print" onclick="window.imprimirCupom('${idPedido}')">üñ®Ô∏è Recibo</button></td></tr>`; return; }
                    let timerHTML = `<span class="sla-timer" data-timestamp="${pedido.dataCriacao ? pedido.dataCriacao.toMillis() : Date.now()}">‚è±Ô∏è Calc...</span>`; let itensHTML = ''; if(pedido.itens) pedido.itens.forEach(i => { itensHTML += `‚Ä¢ ${i.quantidade}x ${i.nome}<br>`; });
                    const isEntrega = pedido.tipoEntrega === 'entrega'; const badgeEntrega = isEntrega ? `<span style="background: #fee2e2; color: #dc2626; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold;">üõµ ENTREGA</span>` : `<span style="background: #e0e7ff; color: #4f46e5; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold;">üö∂ RETIRADA</span>`;
                    const endereco = pedido.endereco || 'Retirada'; const numWhats = pedido.clienteTelefone ? pedido.clienteTelefone.replace(/\D/g, '') : '';
                    const btnWhatsHTML = numWhats ? `<a href="https://wa.me/55${numWhats}" target="_blank" class="btn-mini btn-wpp">üí¨ Falar</a>` : '';
                    let cardHTML = `<div class="order-header-top"><span>#${numPedido} ${badgeEntrega}</span>${timerHTML}</div><div class="action-row"><button class="btn-mini btn-print" onclick="window.imprimirCupom('${idPedido}')">üñ®Ô∏è Imprimir Via</button>${btnWhatsHTML}</div><div class="order-client">üë§ ${pedido.clienteNome || 'Cliente'}</div><div class="order-items">${itensHTML}</div><div class="info-box"><p>üìç <strong>${isEntrega ? 'Endere√ßo:' : 'Retirada'}</strong><br>${endereco}</p><p>üí≥ <strong>Pgto:</strong> ${pedido.pagamento || 'N/A'}</p></div><div class="order-total">${precoFormatado}</div>`;
                    if (pedido.status === 'novo') { contNovos++; if(colunaNovos) colunaNovos.innerHTML += `<div class="order-card status-novo">${cardHTML}<button class="btn-action btn-novo" onclick="window.atualizarStatusPedido('${idPedido}', 'preparo')">Aceitar Pedido</button><button class="btn-cancel" onclick="window.cancelarPedido('${idPedido}')">‚ùå Cancelar</button></div>`; } 
                    else if (pedido.status === 'preparo') { contPreparo++; if(colunaPreparo) colunaPreparo.innerHTML += `<div class="order-card status-preparo">${cardHTML}<button class="btn-action btn-preparo" onclick="window.atualizarStatusPedido('${idPedido}', 'pronto')">Marcar Pronto</button><button class="btn-cancel" onclick="window.cancelarPedido('${idPedido}')">‚ùå Cancelar</button></div>`; } 
                    else if (pedido.status === 'pronto') { contProntos++; if(colunaProntos) colunaProntos.innerHTML += `<div class="order-card status-pronto">${cardHTML}<button class="btn-action btn-pronto" onclick="window.atualizarStatusPedido('${idPedido}', 'concluido')">Despachar / Entregue</button><button class="btn-cancel" onclick="window.cancelarPedido('${idPedido}')">‚ùå Cancelar</button></div>`; }
                });
                if(contNovos===0 && colunaNovos) colunaNovos.innerHTML='<p style="text-align:center; color:var(--text-muted); font-size:0.85rem;">Nenhum novo.</p>'; 
                if(contPreparo===0 && colunaPreparo) colunaPreparo.innerHTML='<p style="text-align:center; color:var(--text-muted); font-size:0.85rem;">Cozinha livre.</p>'; 
                if(contProntos===0 && colunaProntos) colunaProntos.innerHTML='<p style="text-align:center; color:var(--text-muted); font-size:0.85rem;">Nenhum pronto.</p>';
                if(document.getElementById('badge-novos')) document.getElementById('badge-novos').innerText = contNovos; if(document.getElementById('badge-preparo')) document.getElementById('badge-preparo').innerText = contPreparo; if(document.getElementById('badge-prontos')) document.getElementById('badge-prontos').innerText = contProntos;
                if(document.getElementById('kpi-faturamento')) document.getElementById('kpi-faturamento').innerText = formatarMoeda(faturamentoConcluidos); if(document.getElementById('kpi-concluidos')) document.getElementById('kpi-concluidos').innerText = qtdConcluidos; if(document.getElementById('kpi-cancelados')) document.getElementById('kpi-cancelados').innerText = contCancelados; if(document.getElementById('kpi-ticket')) document.getElementById('kpi-ticket').innerText = formatarMoeda(qtdConcluidos > 0 ? (faturamentoConcluidos / qtdConcluidos) : 0);
                const listaCampeoes = document.getElementById('lista-campeoes'); 
                if(listaCampeoes) {
                    listaCampeoes.innerHTML = ''; const produtosOrdenados = Object.entries(dicionarioProdutos).sort((a, b) => b[1] - a[1]).slice(0, 5);
                    if(produtosOrdenados.length === 0) { listaCampeoes.innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem;">Finalize pedidos para ver o ranking.</p>'; } 
                    else { produtosOrdenados.forEach((p, i) => { listaCampeoes.innerHTML += `<li class="ranking-item"><span class="ranking-pos">${i + 1}¬∫</span><span class="ranking-name">${p[0]}</span><span class="ranking-qtd">${p[1]} un</span></li>`; }); }
                }
                if (totalAvals > 0) {
                    const mediaGeral = (somaNotas / totalAvals).toFixed(1);
                    if(document.getElementById('rating-number-big')) document.getElementById('rating-number-big').innerText = mediaGeral;
                    if(document.getElementById('rating-subtitle')) document.getElementById('rating-subtitle').innerText = `${totalAvals} avalia√ß√µes processadas pelo sistema`;
                    for(let i=5; i>=1; i--) { const pct = Math.round((distAvals[i] / totalAvals) * 100); if(document.getElementById(`bar-fill-${i}`)) document.getElementById(`bar-fill-${i}`).style.width = `${pct}%`; if(document.getElementById(`bar-count-${i}`)) document.getElementById(`bar-count-${i}`).innerText = distAvals[i]; }
                } else { if(gridAvaliacoes && gridAvaliacoes.innerHTML === '') gridAvaliacoes.innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem; grid-column: span 2;">Aguardando clientes avaliarem os pedidos conclu√≠dos...</p>'; }
                if(window.atualizarCronometros) atualizarCronometros(); const sino = document.getElementById('contador-notificacoes'); if(sino) { if (contNovos > 0) { sino.style.display = 'inline-block'; sino.innerText = contNovos; } else { sino.style.display = 'none'; } }
            });
        } // FIM DO INICIAR SISTEMA

        window.toggleProdutoStatus = async function(id, isAtivo) { await updateDoc(doc(db, "pratos_cantina", id), { ativo: isAtivo }); }
        window.deletarProduto = async function(id) { if(confirm("Apagar produto definitivamente?")) await deleteDoc(doc(db, "pratos_cantina", id)); }
        window.simularAvaliacaoTeste = async function() {
            const btn = document.querySelector('#tela-avaliacoes .btn-ai'); if(btn) btn.innerText = "Injetando Avalia√ß√£o...";
            const randomID = Math.floor(1000 + Math.random() * 9000);
            await addDoc(collection(db, "pedidos"), { clienteNome: "Cliente Teste " + randomID, status: "concluido", total: 89.90, lojaId: currentLojaId, dataCriacao: serverTimestamp(), avaliacao: { comida: 5, entrega: 5, comentario: "Que sabor incr√≠vel! O lanche chegou perfeitamente montado e bem quente." } });
            if(btn) btn.innerText = "üß™ Simular Avalia√ß√£o para Venda"; alert("‚úÖ Avalia√ß√£o simulada com sucesso! Veja o feed e o dashboard.");
        }
        window.atualizarStatusPedido = async function(id, novoStatus) { window.pararAlarme(); await updateDoc(doc(db, "pedidos", id), { status: novoStatus }); }
        window.cancelarPedido = async function(id) { if(confirm("Deseja CANCELAR este pedido? Ele ir√° para o Hist√≥rico.")) { window.pararAlarme(); await updateDoc(doc(db, "pedidos", id), { status: "cancelado" }); } }

        window.imprimirCupom = function(id) {
            const pedido = window.cachePedidosGlobais[id]; if(!pedido) return;
            const num = id.substring(id.length - 4).toUpperCase(); const data = pedido.dataCriacao ? new Date(pedido.dataCriacao.toMillis()).toLocaleString('pt-BR') : 'Agora';
            let itensPrint = ''; if(pedido.itens) pedido.itens.forEach(i => { itensPrint += `<div>${i.quantidade}x ${i.nome} - ${(i.quantidade * i.precoUnico).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</div>`; });
            const isEnt = pedido.tipoEntrega === 'entrega';
            const urlMotoboy = `https://1butech.com/motoboy.html?id=${id}`; 
            const qrCodeImg = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(urlMotoboy)}" style="width: 120px; height: 120px; margin: 10px auto; display: block;">`;
            const qrCodeSection = isEnt ? `<div class="print-center print-bold" style="font-size: 12px; margin-top: 10px;">√ÅREA DO MOTOBOY</div><div class="print-center" style="font-size: 10px;">Escaneie o QR Code abaixo:</div>${qrCodeImg}<div class="print-hr"></div>` : '';
            document.getElementById('cupom-impressao').innerHTML = `<div class="print-center print-bold" style="font-size: 16px;">MANGIARE DELIVERY</div><div class="print-center">${data}</div><div class="print-hr"></div><div class="print-center print-bold" style="font-size: 18px;">PEDIDO #${num}</div><div class="print-center print-bold" style="font-size: 14px;">${isEnt ? 'üõµ ENTREGA' : 'üö∂ RETIRADA'}</div><div class="print-hr"></div><div class="print-bold">CLIENTE:</div><div>${pedido.clienteNome}</div><div>Tel: ${pedido.clienteTelefone || 'N/A'}</div><br><div class="print-bold">${isEnt ? 'ENDERE√áO:' : 'TIPO:'}</div><div>${pedido.endereco || 'Retirada no Balc√£o'}</div><div class="print-hr"></div><div class="print-bold">ITENS DO PEDIDO:</div>${itensPrint}<div class="print-hr"></div><div>Forma de Pgto: ${pedido.pagamento || 'N/A'}</div><div class="print-bold" style="text-align: right; font-size: 14px; margin-top: 10px;">TOTAL: ${pedido.total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</div><div class="print-hr"></div>${qrCodeSection}<div class="print-center">Obrigado pela preferencia!</div>`;
            setTimeout(() => { window.print(); }, 500); 
        }

        function atualizarCronometros() {
            const agoraticks = Date.now(); document.querySelectorAll('.sla-timer').forEach(element => {
                const tempoCriacao = parseInt(element.getAttribute('data-timestamp'));
                let diferencaMinutos = Math.floor((agoraticks - tempoCriacao) / 60000); if(diferencaMinutos < 0) diferencaMinutos = 0; 
                element.innerText = `‚è±Ô∏è ${diferencaMinutos} min`; if(diferencaMinutos >= 30) { element.classList.add('atrasado'); } else { element.classList.remove('atrasado'); }
            });
        }
        setInterval(atualizarCronometros, 60000); 

        window.copiarLinkCardapio = function() {
            const idDaLoja = window.currentLojaId || 'demo';
            const link = `https://1butech.com/cardapio.html?loja=${idDaLoja}`;
            navigator.clipboard.writeText(link).then(() => {
                const btn = document.getElementById('btn-copiar-link'); const textoOriginal = btn.innerHTML;
                btn.innerHTML = '‚úÖ Link Copiado!'; btn.style.background = '#dcfce7'; btn.style.color = '#166534'; btn.style.borderColor = '#166534';
                setTimeout(() => { btn.innerHTML = textoOriginal; btn.style.background = '#f3f4f6'; btn.style.color = 'var(--brand-color)'; btn.style.borderColor = 'var(--brand-color)'; }, 3000);
            }).catch(err => { alert('N√£o foi poss√≠vel copiar automaticamente. Seu link √©: ' + link); });
        }
    </script>
</body>
</html>